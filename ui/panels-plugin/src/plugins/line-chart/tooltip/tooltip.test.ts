// Copyright 2021 The Perses Authors
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import { getNearbySeries } from './tooltip-model';

describe('getNearbySeries', () => {
  const seriesMock = [
    {
      name: 'device="/dev/vda1", env="demo", fstype="ext4", instance="demo.do.prometheus.io:9100", job="node", mountpoint="/"',
      color: 'hsla(-141599372,50%,50%,0.8)',
      data: [
        [1640801832000, 0.2737455484132848],
        [1640801863000, 0.27375046378953305],
        [1640801894000, 0.2737577575736434],
        [1640801925000, 0.2737625143893676],
        [1640801956000, 0.2737672712050917],
        [1640801987000, 0.27377218658133995],
        [1640802018000, 0.27377694339706404],
        [1640802049000, 0.2737818587733124],
        [1640802080000, 0.2737866155890365],
        [1640802111000, 0.2737913724047606],
        [1640802142000, 0.27379628778100884],
        [1640802173000, 0.2738012031572572],
        [1640802204000, 0.27380611853350545],
        [1640802235000, 0.27381087534922954],
        [1640802266000, 0.2738157907254778],
        [1640802297000, 0.273820547541202],
        [1640802328000, 0.2738253043569261],
        [1640802359000, 0.27383259814103644],
        [1640802390000, 0.27383735495676054],
        [1640802421000, 0.2738422703330088],
        [1640802452000, 0.273847027148733],
        [1640802483000, 0.27385194252498124],
        [1640802514000, 0.27385669934070533],
        [1640802545000, 0.27386145615642943],
        [1640802576000, 0.2738663715326778],
        [1640802607000, 0.2738711283484019],
        [1640802638000, 0.274038251140843],
        [1640802669000, 0.2740430079565671],
        [1640802700000, 0.27404792333281536],
        [1640802731000, 0.27405268014853945],
        [1640802762000, 0.27405743696426366],
        [1640802793000, 0.2740623523405119],
        [1640802824000, 0.2740694875640981],
        [1640802855000, 0.27407440294034635],
        [1640802886000, 0.27407915975607045],
        [1640802917000, 0.2740840751323188],
        [1640802948000, 0.2740888319480429],
        [1640802979000, 0.27409374732429115],
      ],
    },
    {
      name: 'device="/dev/vda15", env="demo", fstype="vfat", instance="demo.do.prometheus.io:9100", job="node", mountpoint="/boot/efi"',
      color: 'hsla(569657620,50%,50%,0.8)',
      data: [
        [1640801832000, 0.08486496097624885],
        [1640801863000, 0.08486496097624885],
        [1640801894000, 0.08486496097624885],
        [1640801925000, 0.08486496097624885],
        [1640801956000, 0.08486496097624885],
        [1640801987000, 0.08486496097624885],
        [1640802018000, 0.08486496097624885],
        [1640802049000, 0.08486496097624885],
        [1640802080000, 0.08486496097624885],
        [1640802111000, 0.08486496097624885],
        [1640802142000, 0.08486496097624885],
        [1640802173000, 0.08486496097624885],
        [1640802204000, 0.08486496097624885],
        [1640802235000, 0.08486496097624885],
        [1640802266000, 0.08486496097624885],
        [1640802297000, 0.08486496097624885],
        [1640802328000, 0.08486496097624885],
        [1640802359000, 0.08486496097624885],
        [1640802390000, 0.08486496097624885],
        [1640802421000, 0.08486496097624885],
        [1640802452000, 0.08486496097624885],
        [1640802483000, 0.08486496097624885],
        [1640802514000, 0.08486496097624885],
        [1640802545000, 0.08486496097624885],
        [1640802576000, 0.08486496097624885],
        [1640802607000, 0.08486496097624885],
        [1640802638000, 0.08486496097624885],
        [1640802669000, 0.08486496097624885],
        [1640802700000, 0.08486496097624885],
        [1640802731000, 0.08486496097624885],
        [1640802762000, 0.08486496097624885],
        [1640802793000, 0.08486496097624885],
        [1640802824000, 0.08486496097624885],
        [1640802855000, 0.08486496097624885],
        [1640802886000, 0.08486496097624885],
        [1640802917000, 0.08486496097624885],
        [1640802948000, 0.08486496097624885],
        [1640802979000, 0.08486496097624885],
      ],
    },
  ];

  const pointInGridMock = [1640802452000.2622, 0.09444444444444444];

  const focusedSeriesOutput = [
    {
      date: '12/29/2021, 1:27:32 PM',
      datumIdx: 20,
      markerColor: 'hsla(569657620,50%,50%,0.8)',
      seriesIdx: 1,
      seriesName:
        'device="/dev/vda15", env="demo", fstype="vfat", instance="demo.do.prometheus.io:9100", job="node", mountpoint="/boot/efi"',
      x: 1640802452000,
      y: 0.08486496097624885,
    },
  ];

  it('should return focused series data for points nearby the cursor', () => {
    expect(getNearbySeries(seriesMock, pointInGridMock, 31000)).toEqual(focusedSeriesOutput);
  });
});
